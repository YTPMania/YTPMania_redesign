define("discourse/plugins/discourse-presence/discourse/components/composer-presence-display",["exports","@ember/component","@ember/template-factory","discourse-common/utils/decorators","@ember/object/computed","@ember/service"],(function(e,s,r,n,t,i){"use strict"
var l,o,a,c,p,u,d,h,m,b
function y(e,s,r,n,t){var i={}
return Object.keys(n).forEach((function(e){i[e]=n[e]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=r.slice().reverse().reduce((function(r,n){return n(e,s,r)||r}),i),t&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(t):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,s,i),i=null),i}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
const f=(0,r.createTemplateFactory)({id:"qNZjYTNd",block:'[[[41,[30,0,["shouldDisplay"]],[[[1,"  "],[10,0],[14,0,"presence-users"],[12],[1,"\\n    "],[10,0],[14,0,"presence-avatars"],[12],[1,"\\n"],[42,[28,[37,2],[[28,[37,2],[[30,0,["presenceUsers"]]],null]],null],null,[[[1,"        "],[1,[28,[35,3],[[30,1]],[["imageSize"],["small"]]]],[1,"\\n"]],[1]],null],[1,"    "],[13],[1,"\\n    "],[10,1],[14,0,"presence-text"],[12],[1,"\\n      "],[10,1],[14,0,"description"],[12],[1,"\\n"],[41,[30,0,["isReply"]],[[[1,[28,[35,4],["presence.replying"],[["count"],[[30,0,["presenceUsers","length"]]]]]]],[]],[[[1,[28,[35,4],["presence.editing"],[["count"],[[30,0,["presenceUsers","length"]]]]]]],[]]],[1,""],[13],[1,""],[10,1],[14,0,"wave"],[12],[1,""],[10,1],[14,0,"dot"],[12],[1,"."],[13],[1,""],[10,1],[14,0,"dot"],[12],[1,"."],[13],[1,""],[10,1],[14,0,"dot"],[12],[1,"."],[13],[1,""],[13],[1,"\\n    "],[13],[1,"\\n  "],[13],[1,"\\n"]],[]],null]],["user"],false,["if","each","-track-array","avatar","i18n"]]',moduleName:"discourse/plugins/discourse-presence/discourse/components/composer-presence-display.hbs",isStrictMode:!1})
var C=(0,s.setComponentTemplate)(f,s.default.extend((l=(0,n.default)("model.replyingToTopic","model.editingPost","model.whisper","model.composerOpened"),o=(0,n.default)("model.topic.id","isReply","isWhisper"),a=(0,n.default)("model.topic.id","isReply","isWhisper"),c=(0,n.default)("isEdit","model.post.id"),p=(0,n.observes)("replyChannelName","whisperChannelName","editChannelName"),u=(0,n.default)("isReply","replyingUsers.[]","editingUsers.[]"),d=(0,n.on)("didInsertElement"),h=(0,n.observes)("model.reply","state","model.post.id","model.topic.id"),m=(0,n.on)("willDestroyElement"),y(b={tagName:"",presence:(0,i.inject)(),composerPresenceManager:(0,i.inject)(),state(e,s,r,n){if(n)return s?"edit":r?"whisper":e?"reply":void 0},isReply:(0,t.equal)("state","reply"),isEdit:(0,t.equal)("state","edit"),isWhisper:(0,t.equal)("state","whisper"),replyChannelName(e,s,r){if(e&&(s||r))return`/discourse-presence/reply/${e}`},whisperChannelName(e,s,r){if(e&&this.currentUser.whisperer&&(s||r))return`/discourse-presence/whisper/${e}`},editChannelName(e,s){if(e)return`/discourse-presence/edit/${s}`},_setupChannel(e,s){this[e]?.name!==s&&(this[e]?.unsubscribe(),s?(this.set(e,this.presence.getChannel(s)),this[e].subscribe()):this[e]&&this.set(e,null))},_setupChannels(){this._setupChannel("replyChannel",this.replyChannelName),this._setupChannel("whisperChannel",this.whisperChannelName),this._setupChannel("editChannel",this.editChannelName)},_cleanupChannels(){this._setupChannel("replyChannel",null),this._setupChannel("whisperChannel",null),this._setupChannel("editChannel",null)},replyingUsers:(0,t.union)("replyChannel.users","whisperChannel.users"),editingUsers:(0,t.readOnly)("editChannel.users"),presenceUsers(e,s,r){const n=e?s:r
return n?.filter((e=>e.id!==this.currentUser.id))?.slice(0,this.siteSettings.presence_max_users_shown)},shouldDisplay:(0,t.gt)("presenceUsers.length",0),subscribe(){this._setupChannels()},_contentChanged(){if(""===this.model.reply)return
const e="edit"===this.state?this.model?.post:this.model?.topic
this.composerPresenceManager.notifyState(this.state,e?.id)},closeComposer(){this._cleanupChannels(),this.composerPresenceManager.leave()}},"state",[l],Object.getOwnPropertyDescriptor(b,"state"),b),y(b,"replyChannelName",[o],Object.getOwnPropertyDescriptor(b,"replyChannelName"),b),y(b,"whisperChannelName",[a],Object.getOwnPropertyDescriptor(b,"whisperChannelName"),b),y(b,"editChannelName",[c],Object.getOwnPropertyDescriptor(b,"editChannelName"),b),y(b,"_setupChannels",[p],Object.getOwnPropertyDescriptor(b,"_setupChannels"),b),y(b,"presenceUsers",[u],Object.getOwnPropertyDescriptor(b,"presenceUsers"),b),y(b,"subscribe",[d],Object.getOwnPropertyDescriptor(b,"subscribe"),b),y(b,"_contentChanged",[h],Object.getOwnPropertyDescriptor(b,"_contentChanged"),b),y(b,"closeComposer",[m],Object.getOwnPropertyDescriptor(b,"closeComposer"),b),b)))
e.default=C})),define("discourse/plugins/discourse-presence/discourse/components/topic-presence-display",["exports","@ember/component","@ember/template-factory","discourse-common/utils/decorators","@ember/object/computed","@ember/service"],(function(e,s,r,n,t,i){"use strict"
var l,o,a,c,p,u
function d(e,s,r,n,t){var i={}
return Object.keys(n).forEach((function(e){i[e]=n[e]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=r.slice().reverse().reduce((function(r,n){return n(e,s,r)||r}),i),t&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(t):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,s,i),i=null),i}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
const h=(0,r.createTemplateFactory)({id:"Q0K+9CNI",block:'[[[41,[30,0,["shouldDisplay"]],[[[1,"  "],[10,0],[14,0,"presence-users"],[12],[1,"\\n    "],[10,0],[14,0,"presence-avatars"],[12],[1,"\\n"],[42,[28,[37,2],[[28,[37,2],[[30,0,["users"]]],null]],null],null,[[[1,"        "],[8,[39,3],null,[["@user"],[[30,1]]],[["default"],[[[[1,"\\n          "],[1,[28,[35,4],[[30,1]],[["imageSize"],["small"]]]],[1,"\\n        "]],[]]]]],[1,"\\n"]],[1]],null],[1,"    "],[13],[1,"\\n    "],[10,1],[14,0,"presence-text"],[12],[1,"\\n      "],[10,1],[14,0,"description"],[12],[1,"\\n        "],[1,[28,[35,5],["presence.replying_to_topic"],[["count"],[[30,0,["users","length"]]]]]],[1,"\\n      "],[13],[1,"\\n      "],[10,1],[14,0,"wave"],[12],[1,""],[10,1],[14,0,"dot"],[12],[1,"."],[13],[1,""],[10,1],[14,0,"dot"],[12],[1,"."],[13],[1,""],[10,1],[14,0,"dot"],[12],[1,"."],[13],[1,""],[13],[1,"\\n    "],[13],[1,"\\n  "],[13],[1,"\\n"]],[]],null]],["user"],false,["if","each","-track-array","user-link","avatar","i18n"]]',moduleName:"discourse/plugins/discourse-presence/discourse/components/topic-presence-display.hbs",isStrictMode:!1})
var m=(0,s.setComponentTemplate)(h,s.default.extend((l=(0,n.default)("replyChannel.users.[]"),o=(0,n.default)("whisperChannel.users.[]"),a=(0,n.default)("topic.id"),c=(0,n.default)("topic.id"),p=(0,n.on)("willDestroyElement"),u={topic:null,presence:(0,i.inject)(),replyChannel:null,whisperChannel:null,replyUsers(e){return e?.filter((e=>e.id!==this.currentUser.id))},whisperUsers(e){return e?.filter((e=>e.id!==this.currentUser.id))},users:(0,t.union)("replyUsers","whisperUsers"),replyChannelName:e=>`/discourse-presence/reply/${e}`,whisperChannelName:e=>`/discourse-presence/whisper/${e}`,shouldDisplay:(0,t.gt)("users.length",0),didReceiveAttrs(){this._super(...arguments),this.replyChannel?.name!==this.replyChannelName&&(this.replyChannel?.unsubscribe(),this.set("replyChannel",this.presence.getChannel(this.replyChannelName)),this.replyChannel.subscribe()),this.currentUser.staff&&this.whisperChannel?.name!==this.whisperChannelName&&(this.whisperChannel?.unsubscribe(),this.set("whisperChannel",this.presence.getChannel(this.whisperChannelName)),this.whisperChannel.subscribe())},_destroyed(){this.replyChannel?.unsubscribe(),this.whisperChannel?.unsubscribe()}},d(u,"replyUsers",[l],Object.getOwnPropertyDescriptor(u,"replyUsers"),u),d(u,"whisperUsers",[o],Object.getOwnPropertyDescriptor(u,"whisperUsers"),u),d(u,"replyChannelName",[a],Object.getOwnPropertyDescriptor(u,"replyChannelName"),u),d(u,"whisperChannelName",[c],Object.getOwnPropertyDescriptor(u,"whisperChannelName"),u),d(u,"_destroyed",[p],Object.getOwnPropertyDescriptor(u,"_destroyed"),u),u)))
e.default=m})),define("discourse/plugins/discourse-presence/discourse/services/composer-presence-manager",["exports","@ember/service","@ember/runloop","discourse-common/config/environment"],(function(e,s,r,n){"use strict"
var t,i
Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
let l=(t=class extends s.default{constructor(){var e,s,r,n
super(...arguments),e=this,s="presence",n=this,(r=i)&&Object.defineProperty(e,s,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(n):void 0})}notifyState(e,s){if(this.siteSettings.allow_users_to_hide_profile&&this.currentUser.user_option.hide_profile_and_presence)return
if(void 0===e)return this.leave()
if(!["reply","whisper","edit"].includes(e))throw`Unknown intent ${e}`
const t=`${e}/${s}`
this._state!==t&&(this._enter(e,s),this._state=t),(0,n.isTesting)()||(this._autoLeaveTimer=(0,r.debounce)(this,this.leave,1e4))}leave(){this._presentChannel?.leave(),this._presentChannel=null,this._state=null,this._autoLeaveTimer&&((0,r.cancel)(this._autoLeaveTimer),this._autoLeaveTimer=null)}_enter(e,s){this.leave()
let r=`/discourse-presence/${e}/${s}`
this._presentChannel=this.presence.getChannel(r),this._presentChannel.enter()}willDestroy(){this.leave()}},o=t.prototype,a="presence",c=[s.inject],p={configurable:!0,enumerable:!0,writable:!0,initializer:null},d={},Object.keys(p).forEach((function(e){d[e]=p[e]})),d.enumerable=!!d.enumerable,d.configurable=!!d.configurable,("value"in d||d.initializer)&&(d.writable=!0),d=c.slice().reverse().reduce((function(e,s){return s(o,a,e)||e}),d),u&&void 0!==d.initializer&&(d.value=d.initializer?d.initializer.call(u):void 0,d.initializer=void 0),void 0===d.initializer&&(Object.defineProperty(o,a,d),d=null),i=d,t)
var o,a,c,p,u,d
e.default=l})),define("discourse/plugins/discourse-presence/discourse/templates/connectors/before-composer-controls/presence",["exports","@ember/template-factory"],(function(e,s){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
var r=(0,s.createTemplateFactory)({id:"G/OxL/Vj",block:'[[[8,[39,0],null,[["@model"],[[30,0,["model"]]]],null]],[],false,["composer-presence-display"]]',moduleName:"discourse/plugins/discourse-presence/discourse/templates/connectors/before-composer-controls/presence.hbs",isStrictMode:!1})
e.default=r})),define("discourse/plugins/discourse-presence/discourse/templates/connectors/topic-above-footer-buttons/presence",["exports","@ember/template-factory"],(function(e,s){"use strict"
Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0
var r=(0,s.createTemplateFactory)({id:"CmudhbhK",block:'[[[8,[39,0],null,[["@topic"],[[30,0,["model"]]]],null]],[],false,["topic-presence-display"]]',moduleName:"discourse/plugins/discourse-presence/discourse/templates/connectors/topic-above-footer-buttons/presence.hbs",isStrictMode:!1})
e.default=r}))

//# sourceMappingURL=discourse-presence-b01b55cb1d4c8ea3deddf73d84a4b4c05b1b5a2b36c1cece616a733e7e923627.map
//!

;
